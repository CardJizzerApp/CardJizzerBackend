# variables:
#     IMAGE_NAME: "mypenink/cah-backend"
#     EXPOSE_PORT: 30001
#     CONTAINER_NAME: "CAH-Backend"
#     CONTAINER_PORT: 443
    
# stages:
#     - build
#     - deploy

# build:
#     stage: build
#     script:
#         - docker build -t $IMAGE_NAME .
#         - docker login -u mypenink -p $docker_pw
#         - docker push $IMAGE_NAME

# deploy:
#     stage: deploy
#     script:
#         - docker rm -f $CONTAINER_NAME || true
#         - docker rmi -f $IMAGE_NAME || true
#         - docker run -d -p $EXPOSE_PORT:$CONTAINER_PORT --name $CONTAINER_NAME $IMAGE_NAME

variables:
    IMAGE_NAME: "mypenink/cardjizzer-backend"

stages:
    - code_quality
    - test
    - build
    - deploy

build_base_image:
    stage: build
    image: docker:stable-git
    services: 
        - docker-stable-dind
    script:
        - docker login -u $docker_username -p $docker_pw
        - docker build -t ${IMAGE_NAME}-build -f ./Dockerfile-Build .
        - docker push $IMAGE_NAME
    only:
        refs:
            - /^feature-.*/
        changes:
            - Dockerfile-Build
            - package.json

image: $IMAGE_NAME
test:
    stage: test
    script:
        - npm run test

build:
    stage: build
    script:
        - npm run build
